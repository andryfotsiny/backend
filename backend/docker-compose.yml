# ─────────────────────────────────────────────
# DYLETH API — docker-compose.yml
# Port API : 3015 (libre sur le serveur)
# PostgreSQL isolé : port interne uniquement
# ─────────────────────────────────────────────

services:

  # ─── PostgreSQL ───────────────────────────
  dyleth-postgres:
    image: postgres:16-alpine
    container_name: dyleth-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: dyleth
      POSTGRES_PASSWORD: dyleth123
      POSTGRES_DB: dyleth
    volumes:
      - dyleth_postgres_data:/var/lib/postgresql/data
    networks:
      - dyleth-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dyleth -d dyleth"]
      interval: 10s
      timeout: 5s
      retries: 5
    # ⚠️ Pas de ports exposés au public — accès interne uniquement

  # ─── Redis ────────────────────────────────
  dyleth-redis:
    image: redis:7-alpine
    container_name: dyleth-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - dyleth_redis_data:/data
    networks:
      - dyleth-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    # ⚠️ Pas de ports exposés au public

  # ─── Qdrant ───────────────────────────────
  dyleth-qdrant:
    image: qdrant/qdrant:latest
    container_name: dyleth-qdrant
    restart: unless-stopped
    volumes:
      - dyleth_qdrant_data:/qdrant/storage
    networks:
      - dyleth-network
    # Pas de healthcheck — l'image qdrant n'a ni curl ni wget dispo
    # ⚠️ Pas de ports exposés au public

  # ─── API FastAPI ──────────────────────────
  dyleth-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dyleth-api
    restart: unless-stopped
    ports:
      - "127.0.0.1:3015:8000"   # Exposé en local → Nginx s'en occupe
    environment:
      PROJECT_NAME: "DYLETH API"
      VERSION: "1.0.0"
      API_V1_STR: "/api/v1"
      SECRET_KEY: ${SECRET_KEY}
      ALGORITHM: ${ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      DATABASE_URL: postgresql+asyncpg://dyleth:dyleth123@dyleth-postgres:5432/dyleth
      REDIS_URL: redis://dyleth-redis:6379/0
      QDRANT_URL: http://dyleth-qdrant:6333
      CORS_ORIGINS: ${CORS_ORIGINS:-["*"]}
      ML_MODEL_PATH: /app/models/ml_models
      FRAUD_CONFIDENCE_THRESHOLD: ${FRAUD_CONFIDENCE_THRESHOLD:-0.7}
      MAX_REQUESTS_PER_MINUTE: ${MAX_REQUESTS_PER_MINUTE:-100}
    volumes:
      - dyleth_models:/app/models/ml_models
      - dyleth_data:/app/data/datasets
    depends_on:
      dyleth-postgres:
        condition: service_healthy
      dyleth-redis:
        condition: service_healthy
      dyleth-qdrant:
        condition: service_started   # Qdrant n'a pas de healthcheck
    networks:
      - dyleth-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─── Migrations Alembic (one-shot) ────────
  dyleth-migrate:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dyleth-migrate
    command: alembic upgrade head
    environment:
      DATABASE_URL: postgresql+asyncpg://dyleth:dyleth123@dyleth-postgres:5432/dyleth
    depends_on:
      dyleth-postgres:
        condition: service_healthy
    networks:
      - dyleth-network
    restart: "no"   # S'exécute une seule fois

  # ─── Celery Worker ────────────────────────
  dyleth-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dyleth-worker
    command: celery -A app.workers.celery_app worker --loglevel=info -Q ml,db,analytics,notifications --concurrency=2
    environment:
      DATABASE_URL: postgresql+asyncpg://dyleth:dyleth123@dyleth-postgres:5432/dyleth
      REDIS_URL: redis://dyleth-redis:6379/0
      QDRANT_URL: http://dyleth-qdrant:6333
      SECRET_KEY: ${SECRET_KEY}
      ML_MODEL_PATH: /app/models/ml_models
    volumes:
      - dyleth_models:/app/models/ml_models
      - dyleth_data:/app/data/datasets
    depends_on:
      dyleth-postgres:
        condition: service_healthy
      dyleth-redis:
        condition: service_healthy
    networks:
      - dyleth-network
    restart: unless-stopped

  # ─── Celery Beat (Scheduler) ──────────────
  dyleth-beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dyleth-beat
    command: celery -A app.workers.celery_app beat --loglevel=info
    environment:
      DATABASE_URL: postgresql+asyncpg://dyleth:dyleth123@dyleth-postgres:5432/dyleth
      REDIS_URL: redis://dyleth-redis:6379/0
      SECRET_KEY: ${SECRET_KEY}
    depends_on:
      dyleth-redis:
        condition: service_healthy
    networks:
      - dyleth-network
    restart: unless-stopped

# ─── Volumes persistants ──────────────────────
volumes:
  dyleth_postgres_data:
  dyleth_redis_data:
  dyleth_qdrant_data:
  dyleth_models:
  dyleth_data:

# ─── Réseau isolé ─────────────────────────────
networks:
  dyleth-network:
    driver: bridge
    name: dyleth-network